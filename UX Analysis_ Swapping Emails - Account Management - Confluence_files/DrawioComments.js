(function(){var w=null,n=null!=window.DrawioProperties?DrawioProperties.contextPath:AJS.contextPath();EditorUi.prototype.getCurrentUser=function(){return null==w?($.ajax({url:n+"/rest/api/user/current",type:"GET",success:function(b){w=new DrawioUser(b.userKey,b.username,b.displayName,b.profilePicture.path)},error:function(b){},dataType:"json"}),new DrawioUser(Date.now(),null,"Anonymous")):w};EditorUi.prototype.commentsSupported=function(){return!0};EditorUi.prototype.canReplyToReplies=function(){return!1};
EditorUi.prototype.toDrawioComment=function(b,e,a,c){var d=a.history.createdBy;d=new DrawioComment({id:b,ver:e,ui:this},a.id,decodeURIComponent(a.body.storage.value),a.version.when,a.history.createdDate,!1,new DrawioUser(d.userKey,d.username,d.displayName,d.profilePicture.path));d.parentId=c;d.version=a.version.number;"$$DELETED$$"==d.content&&(d.content=mxResources.get("msgDeleted"),d.isLocked=!0);c=null!=a.children?a.children.comment.results:[];for(var g=0;g<c.length;g++){var h=this.toDrawioComment(b,
e,c[g],a.id);d.addReplyDirect(h);0==h.content.indexOf("$$RES$$ ")&&(h.content=h.content.substring(8),d.isResolved=g==c.length-1)}return d};EditorUi.prototype.getContentProperty=function(b,e,a,c){$.ajax({url:n+"/rest/api/content/"+encodeURIComponent(b)+"/property?limit\x3d200\x26expand\x3dversion",type:"GET",success:function(d){d=d.results.filter(function(g){return g.key==e});0<d.length?a(d[0]):c({status:404,responseText:'{"statusCode":404,"message":"com.atlassian.confluence.api.service.exceptions.NotFoundException"}'})},
error:c,dataType:"json"})};EditorUi.prototype.setContentProperty=function(b,e,a,c,d,g){a={value:a};c?a.version={number:c+1,minorEdit:!0}:a.key=e;$.ajax({url:n+"/rest/api/content/"+encodeURIComponent(b)+"/property"+(c?"/"+encodeURIComponent(e)+"?expand\x3dversion":""),type:c?"PUT":"POST",data:JSON.stringify(a),success:d,error:g,dataType:"json",contentType:"application/json"})};EditorUi.prototype.setCommentsAttVersIndex=function(b,e){this.setContentProperty(b,"commentsAttVerIndex",JSON.stringify(e),
this.curCommentIndexVer,mxUtils.bind(this,function(a){this.curCommentIndexVer=a.version.number}),function(){})};EditorUi.prototype.getCommentsAttVersIndex=function(b,e,a){this.getContentProperty(b,"commentsAttVerIndex",mxUtils.bind(this,function(c){this.curCommentIndexVer=c.version.number;try{this.curCommentIndex=JSON.parse(c.value);var d=this.editor.attachmentInfo;d&&this.curCommentIndex.length>d.revision&&(this.curCommentIndex=[])}catch(g){this.curCommentIndex=[]}e(this.curCommentIndex)}),mxUtils.bind(this,
function(){this.curCommentIndex=[];a()}))};EditorUi.prototype.getAttVersWithComments=function(b,e,a,c){function d(t,p,l,v){function m(k){$.ajax({url:n+"/rest/api/content/"+encodeURIComponent(b)+"/child/comment?limit\x3d200\x26parentVersion\x3d"+encodeURIComponent(k),type:"GET",success:function(x){0<x.results.length&&(u.push(k),q[k]=!0);f++;f==r&&l()},error:v})}for(var f=0,r=p-t+1;t<=p;t++)m(t)}function g(){h>e?a(u,q):(d(h,Math.min(h+4,e),g,c),h+=5)}var h=1,u=[],q={};g()};EditorUi.prototype.getComments=
function(b,e,a,c){var d=this.editor.attachmentInfo,g=[],h;if(d&&d.attachmentId){var u=d.attachmentId;a=a||d.revision;this.getCommentsAttVersIndex(u,function(l){h=l.length;p();q()},function(){c?b(!1):q(function(l){h=l.length;p()},e)});var q=mxUtils.bind(this,function(l,v){c&&null==l||this.getAttVersWithComments(u,a,mxUtils.bind(this,function(m,f){for(var r=0,k=0;k<this.curCommentIndex.length;k++)f[this.curCommentIndex[k]]&&r++;if(r!=m.length||this.curCommentIndex.length!=m.length)this.curCommentIndex=
m,this.setCommentsAttVersIndex(u,m);l&&l(this.curCommentIndex)}),function(){console.log("Error while checking integrity of comments index for "+a);v&&v()})}),t=mxUtils.bind(this,function(l,v,m){$.ajax({url:n+"/rest/api/content/"+encodeURIComponent(u)+"/child/comment?limit\x3d200\x26expand\x3dbody.storage,version,history,children.comment.body.storage,children.comment.version,children.comment.history\x26parentVersion\x3d"+encodeURIComponent(l),type:"GET",success:mxUtils.bind(this,function(f){f=f.results;
for(var r=0;r<f.length;r++)if(0==decodeURIComponent(f[r].body.storage.value).indexOf('{"$$PREV_VER$$": ['))$.ajax({url:n+"/rest/api/content/"+encodeURIComponent(f[r].id),type:"DELETE"});else if(c){var k=f[r];null!=k.children?(k=k.children.comment.results.pop(),k=null!=k&&0==decodeURIComponent(k.body.storage.value).indexOf("$$RES$$ ")?!0:!1):k=!1;if(!k){b(!0);return}}else k=this.toDrawioComment(u,l,f[r]),g.push(k);v()}),error:m,dataType:"json"})}),p=mxUtils.bind(this,function(){h--;0>h?b(c?!1:g):t(this.curCommentIndex[h],
p,e)})}else e({message:mxResources.get("saveDiagramFirst",null,"Save diagram first!")})};EditorUi.prototype.hasUnresolvedComments=function(b,e){this.getComments(b,e,null,!0)};EditorUi.prototype.addComment=function(b,e,a){var c=this.editor.attachmentInfo;if(c&&c.attachmentId){var d=c.attachmentId;$.ajax({url:n+"/rest/api/content",type:"POST",data:JSON.stringify({type:"comment",container:{type:"attachment",id:d},body:{storage:{value:encodeURIComponent(b.content),representation:"storage"}}}),success:mxUtils.bind(this,
function(g){b.version=g.version.number;e(g.id);-1==this.curCommentIndex.indexOf(c.revision)&&(this.curCommentIndex.push(c.revision),this.setCommentsAttVersIndex(d,this.curCommentIndex))}),error:a,dataType:"json",contentType:"application/json"})}else a({message:mxResources.get("saveDiagramFirst",null,"Save diagram first!")})};EditorUi.prototype.newComment=function(b,e){var a=this.editor.attachmentInfo||{};return new DrawioComment({id:a.attachmentId,ver:a.revision,ui:this},null,b,Date.now(),Date.now(),
!1,e)};EditorUi.prototype.canComment=function(){return!0};DrawioComment.prototype.addReply=function(b,e,a,c,d){function g(m,f){$.ajax({url:n+"/rest/files/1.0/files/"+encodeURIComponent(t)+"/comments/"+encodeURIComponent(l)+"?attachmentVersion\x3d"+encodeURIComponent(p),type:"PUT",data:JSON.stringify({resolved:m}),success:f,error:a,dataType:"json",contentType:"application/json"})}function h(m){v.editor.attachmentInfo.revision!=p?u(m):$.ajax({url:n+"/rest/api/content",type:"POST",data:JSON.stringify({type:"comment",
ancestors:[{id:l}],container:{type:"attachment",id:t},body:{storage:{value:encodeURIComponent((c?"$$RES$$ ":"")+b.content),representation:"storage"}}}),success:function(f){b.version=f.version.number;q=f.id;m()},error:function(f){0<f.responseText.indexOf("messageKey\x3dparent.comment.does.not.exist")?a({message:mxResources.get("parentCommentDel",null,"Parent comment has been deleted. A reply cannot be added.")}):a(f)},dataType:"json",contentType:"application/json"})}function u(m){$.ajax({url:n+"/rest/files/1.0/files/"+
encodeURIComponent(t)+"/comments?attachmentVersion\x3d"+encodeURIComponent(p),type:"POST",data:JSON.stringify({parentId:l,commentBody:encodeURIComponent((c?"$$RES$$ ":"")+b.content)}),success:function(f){b.version=f.version.number;b.file.ver=p;q=f.id;m()},error:function(f){404==f.status?a({message:mxResources.get("parentCommentDel",null,"Parent comment has been deleted. A reply cannot be added.")}):a(f)},dataType:"json",contentType:"application/json"})}var q=null,t=this.file.id,p=this.file.ver,l=
this.id,v=this.file.ui;c?h(function(){g(!0,function(){e(q)})}):d?g(!1,function(){h(function(){e(q)})}):h(function(){e(q)})};DrawioComment.prototype.editComment=function(b,e,a){this.content=b;$.ajax({url:n+"/rest/api/content/"+encodeURIComponent(this.id),type:"PUT",data:JSON.stringify({type:"comment",body:{storage:{value:encodeURIComponent(b),representation:"storage"}},container:{type:"attachment",id:this.file.id},version:{number:this.version+1}}),success:mxUtils.bind(this,function(c){this.version=
c.version.number;e()}),error:a,dataType:"json",contentType:"application/json"})};DrawioComment.prototype.deleteComment=function(b,e){0==(null!=this.replies?this.replies.length:0)?$.ajax({url:n+"/rest/api/content/"+encodeURIComponent(this.id),type:"DELETE",success:b,error:e,dataType:"json"}):this.editComment("$$DELETED$$",function(){b(!0)},e)};EditorUi.prototype.getCurrentUser()})();